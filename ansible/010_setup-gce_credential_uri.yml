---
- hosts: localhost
  gather_facts: no

  tasks:

   - name: Get credential type object for GCE
     uri:
       url: "{{ tower_base_url }}credential_types/?name=Google+Compute+Engine"
       user: "{{ tower_user }}"
       password: "{{ tower_password }}"
       method: GET
       force_basic_auth: yes
       validate_certs: no
     register: credential_type
   - name: Debug credential type ID
     debug:
        msg:  "Credential Type is {{ credential_type.json.results.0.id }}"
   
   - name: create new Google Credentials
     uri:
       url: "{{ tower_base_url }}credentials/"
       user: "{{ tower_user }}"
       password: "{{ tower_password }}"
       method: GET
       force_basic_auth: yes
       validate_certs: no
       body_format: json
       body: | 
          {
            "name": "GCE Service Account for elk-demo",
            "description": "GCE Service Account for elk-demo",
            "organization": null,
            "credential_type": "{{ credential_type.json.results.0.id }}",
            "inputs": "{{ lookup('file', gce_credential_file) }},
            "user": null,
            "team": null
           }
     register: credential_create
   - name: Debug credential create 
     debug:
        msg:  |
         {{ credential_create }}
   
